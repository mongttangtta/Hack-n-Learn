{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>{{ post.title }}</h2>

  <p>
    <strong>작성자:</strong>
    {% if post.author == '관리자' %}
      {% set display_author = 'admin' %}
    {% else %}
      {% set display_author = post.author %}
    {% endif %}
    {{ display_author }}

    {% if post.author == 'admin' or post.author == '관리자' %}
      <span class="badge badge-admin">관리자</span>
    {% elif post.author == 'system' %}
      <span class="badge badge-system">시스템</span>
    {% else %}
      <span class="badge badge-member">일반회원</span>
    {% endif %}

    &nbsp;&nbsp; <strong>게시판:</strong> {{ post.board }}
  </p>

  <!-- ===== BEGIN: XSS-compatible hook =====
       This snippet overrides window.alert so that alert("1") => alert(flag).
       Kept intentionally small and simple for beginner CTF players.
       ===== -->
  <script>
  (function(){
    // escape the flag in template; it's a JS string literal so we should JSON-encode it.
    // Jinja2: to produce a safe JS string literal we can use |tojson filter if available,
    // but to keep compatibility, we'll escape quotes via |e and then wrap in quotes.
    // Using tojson is preferable if your Jinja supports it.
    var FLAG = {{ flag|tojson | default('""') }};

    // keep original alert
    var _alert = window.alert.bind(window);

    window.alert = function(msg) {
      try {
        // normalize to string
        var s = String(msg);
        if (s === "1") {
          // when the page executes alert("1"), show the flag instead
          _alert(FLAG);
        } else {
          _alert(msg);
        }
      } catch (e) {
        // fallback to original alert on any error
        _alert(msg);
      }
    };
  })();
  </script>
  <!-- ===== END hook ===== -->

  <!-- ⚠️ Stored XSS intentionally enabled for CTF: post.content is rendered as raw HTML -->
  <div style="white-space:pre-wrap; border-top:1px solid #eee; padding-top:8px; margin-top:8px;">
    {{ post.content|safe }}
  </div>

  <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
    {% if session.username == post.author or session.username == 'admin' %}
      <form method="post" action="{{ url_for('delete', post_id=post.id) }}" style="display:inline;">
        <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
        <button type="submit" onclick="return confirm('정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.');">삭제</button>
      </form>
    {% endif %}
    <a href="{{ url_for('board', board=post.board) }}" style="margin-left:24px;">목록으로</a>
  </div>
</div>
{% endblock %}

